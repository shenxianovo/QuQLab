<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>似了喵...</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: #0f172a;
  color: #e2e8f0;
}

header {
  padding: 20px;
  font-size: 22px;
  font-weight: bold;
  background: #111827;
  border-bottom: 1px solid #1f2937;
}

.container {
  padding: 20px;
}

.card {
  background: #1e293b;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  transition: 0.2s ease;
}

.card:hover {
  transform: translateY(-2px);
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 8px;
}

.online {
  background: #22c55e;
}

.offline {
  background: #ef4444;
}

.meta {
  font-size: 13px;
  color: #94a3b8;
  margin-top: 6px;
}

.refresh {
  font-size: 13px;
  color: #64748b;
  margin-top: 10px;
}
</style>
</head>

<body>

<header>似了喵...</header>

<div class="container">
  <div id="devices">Loading...</div>
  <div class="refresh">Auto refresh every 5s</div>
</div>

<script>
const API_URL = "/heartbeat/api/status";   // 如果不是这个路径，改这里
const OFFLINE_THRESHOLD = 60;       // 超过 60 秒算离线

function secondsSince(dateString) {
  const last = new Date(dateString);
  const now = new Date();
  return Math.floor((now - last) / 1000);
}

async function loadStatus() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();

    const container = document.getElementById("devices");

    if (!Object.keys(data).length) {
      container.innerHTML = "<p>No devices yet.</p>";
      return;
    }

    let html = "";

    for (const id in data) {
      const device = data[id];
      const seconds = secondsSince(device.last_seen);
      const isOnline = seconds <= OFFLINE_THRESHOLD;

      html += `
        <div class="card">
          <div>
            <span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>
            <strong>${id}</strong>
          </div>
          <div class="meta">
            App: ${device.app_name}<br>
            Last seen: ${device.last_seen}<br>
            ${isOnline ? "Online" : "Offline"} (${seconds}s ago)
          </div>
        </div>
      `;
    }

    container.innerHTML = html;

  } catch (err) {
    document.getElementById("devices").innerHTML = "Error loading data.";
  }
}

loadStatus();
setInterval(loadStatus, 5000);
</script>

</body>
</html>